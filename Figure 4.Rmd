---
title: "Long transient dynamics in the presence of noise - Figure 4"
author: "Jody Reimer"
date: "`r Sys.Date()`"
output: 
pdf_document: default
---

```{r library, message=F}
library(tidyverse)
library(nimble)
library(ecp)
library(ggplot2)
```
  
Define parameters

```{r}
p <- list(r = .05, K = 2, Q = 5, H = .38, sigma = .02, a=0.023, N = 2700, t.step = 1/2)
growth <- function(x, p) x * p$r * (1 - x / p$K)
consumption <- function(x,p) p$a * x ^ p$Q / (x^p$Q + p$H^p$Q)
```

Define stochastic model in BUGS notation

```{r, message=FALSE}
may  <- nimble::nimbleCode({
  
  x[1] <- x0
  for(t in 1:((1/t.step)*N-1)){
    mu[t] <- x[t] + t.step*(x[t] * r * (1 - x[t] / K)  - a * x[t] ^ Q / (x[t] ^ Q + H ^ Q))
    y[t+1] ~ dnorm(mu[t], sd = sigma*mu[t]*sqrt(t.step)) 
    x[t+1] <- max(y[t+1],0)
  }
})
model <- nimbleModel(may,constants = p, inits = list(x0 = 0.3))
cmodel <- model #compileNimble(model)
```

Simulate 100 stochastic replicates

```{r}
set.seed(12345)
df <- map_dfr(1:100, # change to 100 afterwards
  function(i){
    simulate(cmodel)
    tibble(t = p$t.step*seq_along(cmodel$x), x = cmodel$x, reps = i)
   })
```

Calculate changepoint for each replicate, then calculate mean and standard deviation

```{r changepoint on each individual replicate}
changepoints <- NULL
for (rep in 1:100){
  dat.rep <- df[df$reps==rep,]
  ECP.res <- e.divisive(dat.rep[,2],k=1)
  changepoints[rep] = ECP.res$estimates[2]*p$t.step
}
mean.changept = mean(changepoints)
sd.changept = sd(changepoints)
```

Now, plot the trajectory of the deterministic core.

```{r}
p <- list(r = .05, K = 2, Q = 5, H = .38, sigma = 0, a=0.023, N = 2700, t.step = 1/2)
model <- nimbleModel(may,constants = p, inits = list(x0 = 0.3))
cmodel <- model 
simulate(cmodel)
df0 <- tibble(t = p$t.step*seq_along(cmodel$x), x.sigma0 = cmodel$x)
sigma0 = df0
df0 %>% ggplot(aes(t, x.sigma0)) + geom_line()
```

Next, plot the curve for the mean of 5000 replicates (note, this is the same curve as is generated by the script for Figure 2; to save time, you could save that workspace and load it again here, rather than running all of the following.)

```{r}
p <- list(r = .05, K = 2, Q = 5, H = .38, sigma = 0.02, a=0.023, N = 2700, t.step = 1/2)
model <- nimbleModel(may,constants = p, inits = list(x0 = 0.3))
cmodel <- model 
df2 <- map_dfr(1:5000, 
  function(i){
    simulate(cmodel)
    tibble(t = p$t.step*seq_along(cmodel$x), x = cmodel$x, reps = i)
   })
df.reps <- df2 %>% spread(reps,x)
sigma0.02 = tibble(t = p$t.step*seq_along(cmodel$x),x.sigma0.02=rowMeans(df.reps[,-1]))
ggplot() + geom_line(data = sigma0.02,aes(t,x.sigma0.02),color="yellow",)
```

Now plot the mean "switch" times determined from the Changepoint analysis and the Hidden Markov Model analysis. Note that the value included for the Hidden Markov Model result can be found in the code for Figure 3.

```{r}
ggplot() + 
  geom_line(data = df, aes(t,x,group=reps), alpha=.03) +
  geom_line(data = sigma0.02,aes(t,x.sigma0.02),color="yellow",size=2) +
  geom_line(data=sigma0, aes(t, x.sigma0),color="purple4",size=2) +
  geom_vline(xintercept=mean.changept*p$t.step,color="black",size=1,linetype = "dashed") + #changepoint analysis result
  geom_vline(xintercept=596.25, color="black", size=1, linetype = "dotted") 
# Hidden Markov Model result
  theme_classic() + 
  theme(axis.title = element_text(size=25),
        axis.text = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=25),
        legend.title.align = 0.5,
        legend.text.align = 0) 
```

Save the plot

```{r}

plot_grid(
  plot1,
  ncol = 1)

ggsave(filename="Figure4.png",width=600,heigh=350)
ggsave(filename="Figure4.pdf",width=6,height=3.5)

```
